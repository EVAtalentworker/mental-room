<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI é—®ç­”</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-navbar">
        <div class="nav-content">
            <div class="nav-title">Wegather</div>
        </div>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <!-- åœ¨ sidebar ä¸­æ·»åŠ å†å²è®°å½•å®¹å™¨ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>
                <span id="chatTypeText">æ–‡å­—å¯¹è¯</span>
                <button id="toggleChatType" class="toggle-btn">ğŸ“•</button>
            </h3>
        </div>
        <button id="newChatButton" class="new-chat-btn">æ–°å¯¹è¯</button>
        <button id="clearHistoryButton" class="clear-chat-btn">æ¸…ç©ºå†å²</button>
        <div class="history-divider">å†å²è®°å½•</div>
        <div id="chatHistory" class="chat-history"></div>
        
        <!-- æ·»åŠ è¿”å›ä¸»é¡µæŒ‰é’® -->
        <a href="{{ url_for('index') }}" class="home-btn">è¿”å›ä¸»é¡µ</a>
    </div>

    <div class="main-content">
        <div class="chat-container" id="chat-container">
            <!-- AI åˆå§‹æ¶ˆæ¯ -->
            <div class="message ai-message">
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¯­éŸ³åŠ©æ‰‹ã€‚ä½ å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³è¾“å…¥ã€‚
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <form id="chatForm" class="input-form">
                    <input type="text" class="chat-input" id="textInput" 
                           placeholder="è¾“å…¥æ¶ˆæ¯æˆ–ç‚¹å‡»éº¦å…‹é£è¯­éŸ³è¾“å…¥..." autocomplete="off">
                    <div class="button-group">
                        <button type="button" class="voice-btn" id="recordButton" title="ç‚¹å‡»å¼€å§‹è¯­éŸ³è¾“å…¥">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                <path fill="currentColor" d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                            </svg>
                        </button>
                        <button type="submit" class="send-btn" title="å‘é€æ¶ˆæ¯">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
            <div class="input-footer">
                AIåŠ©æ‰‹ä»…ä¾›å‚è€ƒï¼Œè¯·å‹¿è¿‡åˆ†ä¾èµ–
            </div>
        </div>
    </div>

    <!-- åœ¨ script éƒ¨åˆ†ä¿®æ”¹ä»£ç  -->
    <script>
        const recordButton = document.getElementById('recordButton');
        const chatForm = document.getElementById('chatForm');
        const textInput = document.getElementById('textInput');
        const chatContainer = document.getElementById('chat-container');
        let isRecording = false;
        let isVoiceMode = false;  // æ·»åŠ æ¨¡å¼æ ‡å¿—
        
        // æ›´æ–°åˆ‡æ¢æŒ‰é’®å¤„ç†ç¨‹åº
        const toggleButton = document.getElementById('toggleChatType');
        const chatTypeText = document.getElementById('chatTypeText');

        // æ·»åŠ å¯¹è¯ç®¡ç†ç›¸å…³å˜é‡
        let currentChatId = Date.now().toString();
        let chats = {
            [currentChatId]: {
                name: 'new chat',
                messages: [{
                    type: 'ai',
                    content: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¯­éŸ³åŠ©æ‰‹ã€‚ä½ å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³è¾“å…¥ã€‚'
                }]
            }
        };

        // ä¿®æ”¹åˆ é™¤å¯¹è¯å‡½æ•°
        function deleteChat(chatId) {
            if (Object.keys(chats).length === 1) {
                return; // å¦‚æœåªæœ‰ä¸€ä¸ªå¯¹è¯ï¼Œä¸å…è®¸åˆ é™¤
            }
            
            if (chatId === currentChatId) {
                // åˆ‡æ¢åˆ°å…¶ä»–å¯¹è¯
                const otherChatId = Object.keys(chats).find(id => id !== chatId);
                currentChatId = otherChatId;
                updateChatDisplay();
            }
            delete chats[chatId];
            updateHistoryList();
        }

        // æ›´æ–°æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
        function updateChatDisplay() {
            chatContainer.innerHTML = '';
            chats[currentChatId].messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type}-message`;
                messageDiv.innerHTML = `<div class="message-content">${msg.content}</div>`;
                chatContainer.appendChild(messageDiv);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryList() {
            const historyContainer = document.getElementById('chatHistory');
            historyContainer.innerHTML = '';
            Object.keys(chats).forEach(chatId => {
                if (chatId === 'default') return;
                const chatButton = document.createElement('button');
                chatButton.className = 'history-item' + (chatId === currentChatId ? ' active' : '');
                chatButton.innerHTML = `
                    ${chats[chatId].name}
                    <span class="delete-chat-btn" onclick="event.stopPropagation(); deleteChat('${chatId}')">Ã—</span>
                `;
                chatButton.onclick = () => switchChat(chatId);
                historyContainer.appendChild(chatButton);
            });
        }

        // åˆ‡æ¢å¯¹è¯
        function switchChat(chatId) {
            currentChatId = chatId;
            updateChatDisplay();
            updateHistoryList();
        }

        // ä¿®æ”¹æ·»åŠ æ¶ˆæ¯å‡½æ•°
        function addMessage(text, isUser = false) {
            const messageType = isUser ? 'user' : 'ai';
            const chat = chats[currentChatId];
            
            // å¦‚æœæ˜¯ç”¨æˆ·çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ›´æ–°å¯¹è¯åç§°
            if (isUser && chat.messages.filter(m => m.type === 'user').length === 0) {
                chat.name = text.length > 20 ? text.substring(0, 20) + '...' : text;
                updateHistoryList();
            }
            
            chat.messages.push({
                type: messageType,
                content: text
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageType}-message`;
            messageDiv.innerHTML = `<div class="message-content">${text}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ä¿®æ”¹æ–°å¯¹è¯æŒ‰é’®å¤„ç†ç¨‹åº
        document.getElementById('newChatButton').addEventListener('click', () => {
            const newChatId = Date.now().toString();
            chats[newChatId] = {
                name: 'new chat',
                messages: [{
                    type: 'ai',
                    content: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¯­éŸ³åŠ©æ‰‹ã€‚ä½ å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³è¾“å…¥ã€‚'
                }]
            };
            currentChatId = newChatId;
            updateHistoryList();
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-content">
                        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¯­éŸ³åŠ©æ‰‹ã€‚ä½ å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³è¾“å…¥ã€‚
                    </div>
                </div>
            `;
        });

        // ä¿®æ”¹æ¸…ç©ºå†å²æŒ‰é’®å¤„ç†ç¨‹åº
        document.getElementById('clearHistoryButton').addEventListener('click', () => {
            chats[currentChatId].messages = [{
                type: 'ai',
                content: 'å¯¹è¯å·²æ¸…ç©ºã€‚ä½ å¯ä»¥å¼€å§‹æ–°çš„å¯¹è¯äº†ã€‚'
            }];
            updateChatDisplay();
        });

        toggleButton.addEventListener('click', () => {
            isVoiceMode = !isVoiceMode;
            if (isVoiceMode) {
                toggleButton.textContent = 'ğŸ”ˆ';
                chatTypeText.textContent = 'è¯­éŸ³å¯¹è¯';
            } else {
                toggleButton.textContent = 'ğŸ“•';
                chatTypeText.textContent = 'æ–‡å­—å¯¹è¯';
            }
        });

        // å¤„ç†æ–‡æœ¬è¾“å…¥
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = textInput.value.trim();
            if (!text) return;

            addMessage(text, true);
            textInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: text,
                        isVoiceMode: isVoiceMode
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage(data.response);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        });

        // å¤„ç†è¯­éŸ³è¾“å…¥
        recordButton.addEventListener('click', async () => {
            if (!isRecording) {
                // å¼€å§‹å½•éŸ³
                isRecording = true;
                recordButton.classList.add('recording');
                
                try {
                    const response = await fetch('/start_recording', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('å½•éŸ³å‡ºé”™ï¼Œè¯·é‡è¯•');
                    recordButton.classList.remove('recording');
                    isRecording = false;
                }
            } else {
                // åœæ­¢å½•éŸ³
                try {
                    const response = await fetch('/stop_recording', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            isVoiceMode: isVoiceMode
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        addMessage(data.text, true);
                        addMessage(data.response);
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('è¯†åˆ«å‡ºé”™ï¼Œè¯·é‡è¯•');
                } finally {
                    recordButton.classList.remove('recording');
                    isRecording = false;
                }
            }
        });

        // æ–°å¯¹è¯æŒ‰é’®
        document.getElementById('newChatButton').addEventListener('click', () => {
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-content">
                        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¯­éŸ³åŠ©æ‰‹ã€‚ä½ å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³è¾“å…¥ã€‚
                    </div>
                </div>
            `;
        });

        // æ¸…ç©ºå¯¹è¯æŒ‰é’®
        document.getElementById('clearHistoryButton').addEventListener('click', () => {
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-content">
                        å¯¹è¯å·²æ¸…ç©ºã€‚ä½ å¯ä»¥å¼€å§‹æ–°çš„å¯¹è¯äº†ã€‚
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>