<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI é—®ç­”</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-navbar">
        <div class="nav-content">
            <div class="nav-title">Wegather</div>
        </div>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>
                <span id="chatTypeText">æ–‡å­—å¯¹è¯</span>
                <button id="toggleChatType" class="toggle-btn">ğŸ“•</button>
            </h3>
        </div>
        <button id="newChatButton" class="new-chat-btn">æ–°å¯¹è¯</button>
        <button id="clearHistoryButton" class="clear-chat-btn">æ¸…ç©ºå¯¹è¯</button>
        <div class="history-divider">å†å²è®°å½•</div>
        
        <!-- æ·»åŠ è¿”å›ä¸»é¡µæŒ‰é’® -->
        <a href="{{ url_for('index') }}" class="home-btn">è¿”å›ä¸»é¡µ</a>
    </div>

    <div class="main-content">
        <div class="chat-container" id="chat-container">
            <!-- AI åˆå§‹æ¶ˆæ¯ -->
            <div class="message ai-message">
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¯­éŸ³åŠ©æ‰‹ã€‚ä½ å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³è¾“å…¥ã€‚
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <form id="chatForm" class="input-form">
                    <input type="text" class="chat-input" id="textInput" 
                           placeholder="è¾“å…¥æ¶ˆæ¯æˆ–ç‚¹å‡»éº¦å…‹é£è¯­éŸ³è¾“å…¥..." autocomplete="off">
                    <div class="button-group">
                        <button type="button" class="voice-btn" id="recordButton" title="ç‚¹å‡»å¼€å§‹è¯­éŸ³è¾“å…¥">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                <path fill="currentColor" d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                            </svg>
                        </button>
                        <button type="submit" class="send-btn" title="å‘é€æ¶ˆæ¯">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
            <div class="input-footer">
                AIåŠ©æ‰‹ä»…ä¾›å‚è€ƒï¼Œè¯·å‹¿è¿‡åˆ†ä¾èµ–
            </div>
        </div>
    </div>

    <!-- åœ¨ script éƒ¨åˆ†æ·»åŠ ä»¥ä¸‹ä»£ç  -->
    <script>
        const recordButton = document.getElementById('recordButton');
        const chatForm = document.getElementById('chatForm');
        const textInput = document.getElementById('textInput');
        const chatContainer = document.getElementById('chat-container');
        let isRecording = false;
        let isVoiceMode = false;  // æ·»åŠ æ¨¡å¼æ ‡å¿—
        
        // æ›´æ–°åˆ‡æ¢æŒ‰é’®å¤„ç†ç¨‹åº
        const toggleButton = document.getElementById('toggleChatType');
        const chatTypeText = document.getElementById('chatTypeText');

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            messageDiv.innerHTML = `<div class="message-content">${text}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        toggleButton.addEventListener('click', () => {
            isVoiceMode = !isVoiceMode;
            if (isVoiceMode) {
                toggleButton.textContent = 'ğŸ”ˆ';
                chatTypeText.textContent = 'è¯­éŸ³å¯¹è¯';
            } else {
                toggleButton.textContent = 'ğŸ“•';
                chatTypeText.textContent = 'æ–‡å­—å¯¹è¯';
            }
        });

        // å¤„ç†æ–‡æœ¬è¾“å…¥
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = textInput.value.trim();
            if (!text) return;

            addMessage(text, true);
            textInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: text,
                        isVoiceMode: isVoiceMode
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage(data.response);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        });

        // å¤„ç†è¯­éŸ³è¾“å…¥
        recordButton.addEventListener('click', async () => {
            if (!isRecording) {
                // å¼€å§‹å½•éŸ³
                isRecording = true;
                recordButton.classList.add('recording');
                
                try {
                    const response = await fetch('/start_recording', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('å½•éŸ³å‡ºé”™ï¼Œè¯·é‡è¯•');
                    recordButton.classList.remove('recording');
                    isRecording = false;
                }
            } else {
                // åœæ­¢å½•éŸ³
                try {
                    const response = await fetch('/stop_recording', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            isVoiceMode: isVoiceMode
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        addMessage(data.text, true);
                        addMessage(data.response);
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('è¯†åˆ«å‡ºé”™ï¼Œè¯·é‡è¯•');
                } finally {
                    recordButton.classList.remove('recording');
                    isRecording = false;
                }
            }
        });

        // æ–°å¯¹è¯æŒ‰é’®
        document.getElementById('newChatButton').addEventListener('click', () => {
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-content">
                        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¯­éŸ³åŠ©æ‰‹ã€‚ä½ å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³è¾“å…¥ã€‚
                    </div>
                </div>
            `;
        });

        // æ¸…ç©ºå¯¹è¯æŒ‰é’®
        document.getElementById('clearHistoryButton').addEventListener('click', () => {
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-content">
                        å¯¹è¯å·²æ¸…ç©ºã€‚ä½ å¯ä»¥å¼€å§‹æ–°çš„å¯¹è¯äº†ã€‚
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>