<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 语音助手</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="top-navbar">
        <div class="nav-content">
            <div class="nav-title">AI 语音助手</div>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>语音助手</h3>
        </div>
        <button id="newChatButton" class="new-chat-btn">新对话</button>
        <button id="clearHistoryButton" class="clear-chat-btn">清空对话</button>
        <div class="history-divider">历史记录</div>
        
        <!-- 添加返回主页按钮 -->
        <a href="{{ url_for('index') }}" class="home-btn">返回主页</a>
    </div>

    <div class="main-content">
        <div class="chat-container" id="chat-container">
            <!-- AI 初始消息 -->
            <div class="message ai-message">
                <div class="message-content">
                    你好！我是你的 AI 语音助手。你可以直接输入文字，或点击下方麦克风按钮进行语音输入。
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <form id="chatForm" class="input-form">
                    <input type="text" class="chat-input" id="textInput" 
                           placeholder="输入消息或点击麦克风语音输入..." autocomplete="off">
                    <div class="button-group">
                        <button type="button" class="voice-btn" id="recordButton" title="点击开始语音输入">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                <path fill="currentColor" d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                            </svg>
                        </button>
                        <button type="submit" class="send-btn" title="发送消息">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
            <div class="input-footer">
                AI助手仅供参考，请勿过分依赖
            </div>
        </div>
    </div>

    <script>
        const recordButton = document.getElementById('recordButton');
        const chatForm = document.getElementById('chatForm');
        const textInput = document.getElementById('textInput');
        const chatContainer = document.getElementById('chat-container');
        let isRecording = false;

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            messageDiv.innerHTML = `<div class="message-content">${text}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 处理文本输入
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = textInput.value.trim();
            if (!text) return;

            addMessage(text, true);
            textInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: text })
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage(data.response);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('发生错误，请重试');
            }
        });

        // 处理语音输入
        recordButton.addEventListener('click', async () => {
            if (!isRecording) {
                // 开始录音
                isRecording = true;
                recordButton.classList.add('recording');
                
                try {
                    const response = await fetch('/start_recording', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('录音出错，请重试');
                    recordButton.classList.remove('recording');
                    isRecording = false;
                }
            } else {
                // 停止录音
                try {
                    const response = await fetch('/stop_recording', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        addMessage(data.text, true);
                        addMessage(data.response);
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('识别出错，请重试');
                } finally {
                    recordButton.classList.remove('recording');
                    isRecording = false;
                }
            }
        });

        // 新对话按钮
        document.getElementById('newChatButton').addEventListener('click', () => {
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-content">
                        你好！我是你的 AI 语音助手。你可以直接输入文字，或点击下方麦克风按钮进行语音输入。
                    </div>
                </div>
            `;
        });

        // 清空对话按钮
        document.getElementById('clearHistoryButton').addEventListener('click', () => {
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-content">
                        对话已清空。你可以开始新的对话了。
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>